<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parsons Problem Generator</title>
    <link rel="icon" href="data:,"></link>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #generated-url {
            margin-top: 20px;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Parsons Problem Generator</h1>
    <form id="problem-form">
        <label for="num_problems">Specify Number of Problems:</label>
        <input type="range" id="num_problems" name="num_problems" min="1" max="10" value="3" oninput="numProblemsOutput.value = this.value;">
        <output id="numProblemsOutput">3</output><br><br>
    </form>

    <h2>Problem Specification</h2>
    <pre id="problem-specification"></pre>

    <h2>Generated URL</h2>
    <a id="generated-url" href="#" target="_blank">Click to test the generated URL</a>

    <h2>Generated Problems</h2>
    <button type="button" id="preview-result">Preview Result</button>
    <pre id="output"></pre>

    <h2>Manage Topics</h2>
    <div id="topics-container">
        <ul id="topics-list"></ul>
        <button id="add-topic">Add Topic</button>
    </div>

    <h2>Generate Topics</h2>
    <div id="topic-generator">
        <label for="activity-name">Enter Activity Name:</label>
        <input type="text" id="activity-name" placeholder="e.g., Python Basics">
        <button id="generate-topics">Generate Topics</button>
    </div>

    <h2>Generate Problems</h2>
    <button id="generate-problems">Generate Problems</button>
    <a id="problems-link" href="#" target="_blank" style="display: none;">Click to view problems</a>
    <pre id="problems-output"></pre>

    <script>
        const output = document.getElementById('output');
        const topicsContainer = document.getElementById('topics-container');
        const topicsList = document.getElementById('topics-list');
        const addTopicButton = document.getElementById('add-topic');
        const activityNameInput = document.getElementById('activity-name');
        const generateTopicsButton = document.getElementById('generate-topics');
        const generateProblemsButton = document.getElementById('generate-problems');
        const problemsLink = document.getElementById('problems-link');
        const problemsOutput = document.getElementById('problems-output');

        // Add a new topic
        addTopicButton.addEventListener('click', () => {
            const newTopicInput = document.createElement('input');
            newTopicInput.type = 'text';
            newTopicInput.placeholder = 'Enter new topic';
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.addEventListener('click', () => {
                const newTopic = newTopicInput.value.trim();
                if (newTopic && !Array.from(topicsList.children).some(li => li.textContent === newTopic)) {
                    const li = document.createElement('li');
                    li.textContent = newTopic;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = newTopic;
                    li.prepend(checkbox);
                    topicsList.appendChild(li);
                    newTopicInput.remove();
                    saveButton.remove();
                }
            });
            topicsContainer.appendChild(newTopicInput);
            topicsContainer.appendChild(saveButton);
        });

        // Fetch topics based on the activity name
        generateTopicsButton.addEventListener('click', () => {
            const activityName = activityNameInput.value.trim();
            if (!activityName) {
                alert('Please enter an activity name.');
                return;
            }

            generateTopicsButton.disabled = true;
            fetch(`/generate-topics?activity_name=${encodeURIComponent(activityName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.topics && Array.isArray(data.topics.topics)) {
                        data.topics.topics.forEach(topic => {
                            if (!Array.from(topicsList.children).some(li => li.textContent === topic)) {
                                const li = document.createElement('li');
                                li.textContent = topic;
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.value = topic;
                                li.prepend(checkbox);
                                topicsList.appendChild(li);
                            }
                        });
                    } else {
                        console.error('Invalid response format:', data);
                    }
                })
                .catch(error => console.error('Error generating topics:', error))
                .finally(() => {
                    generateTopicsButton.disabled = false;
                });
        });

        // Generate problems based on selected topics
        generateProblemsButton.addEventListener('click', () => {
            const selectedTopics = Array.from(topicsList.querySelectorAll('input[type="checkbox"]:checked')).map(
                checkbox => checkbox.value
            );

            if (selectedTopics.length === 0) {
                alert('Please select at least one topic.');
                return;
            }

            const numProblems = document.getElementById('num_problems').value;

            const specification = {
                topics: selectedTopics,
                num_problems: parseInt(numProblems, 10),
            };

            generateProblemsButton.disabled = true;
            fetch(`/generate-problems`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(specification),
            })
                .then(response => response.json())
                .then(data => {
                    // Display the problems in the output
                    problemsOutput.textContent = JSON.stringify(data, null, 2);

                    // Generate a link to view the problems
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    problemsLink.href = url;
                    problemsLink.style.display = 'inline';
                })
                .catch(error => console.error('Error generating problems:', error))
                .finally(() => {
                    generateProblemsButton.disabled = false;
                });
        });
    </script>
</body>
</html>
